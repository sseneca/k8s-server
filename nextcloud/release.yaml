apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: nextcloud
  namespace: nextcloud
  annotations:
    fluxcd.io/automated: "true"
    fluxcd.io/tag.chart-image: semver:~20.0-fpm-alpine
    fluxcd.io/tag.postgresql: semver:~13.0
    fluxcd.io/tag.cronjob: semver:~7
spec:
  test:
    enable: true
  rollback:
    enable: true
    retry: true
  releaseName: nextcloud
  chart:
    repository: https://nextcloud.github.io/helm
    name: nextcloud
    version: 2.2.1
  valuesFrom:
    - secretKeyRef:
        name: nextcloud-secrets
  values:
    image:
      repository: nextcloud
      tag: 20.0.0-fpm-alpine
    ingress:
      enabled: true
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: 4G
        cert-manager.io/cluster-issuer: letsencrypt-prod
      tls:
        - hosts:
            - cloud.ssene.ca
          secretName: nextcloud-tls-cert
    nextcloud:
      host: cloud.ssene.ca
      extraVolumes:
        - name: photos
          hostPath:
            storageClassName: local-path
            capacity:
              storage: 200Gi
            accessModes:
              - ReadWriteOnce
            path: /srv/nfs/media/photos
      extraVolumeMounts:
        - name: photos
          mountPath: "/photos"
    nginx:
      enabled: true
    internalDatabase:
      enabled: false
    externalDatabase:
      enabled: true
      type: postgresql
      host: nextcloud-postgresql.nextcloud.svc.cluster.local
    postgresql:
      enabled: true
      persistence:
        enabled: true
        existingClaim: database-nextcloud
      image:
        repository: bitnami/postgresql
        tag: 13.0.0
      volumePermissions:
        enabled: true
      psp:
        create: true
      rbac:
        create: true
    redis:
      enabled: true
    cronjob:
      enabled: true
      image:
        repository: curlimages/curl
        tag: 7.73.0
    persistence:
      enabled: true
